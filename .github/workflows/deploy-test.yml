name: Deploy Testing

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup SSH
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY_TST }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST_TST }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          echo "Host $DEPLOY_HOST" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/deploy_key" >> ~/.ssh/config

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image locally
        run: |
          docker compose build

      - name: Transfer image to server
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST_TST }}
        run: |
          docker save 'ghcr.io/generation-d/application-platform:latest' | gzip | ssh "$DEPLOY_USER@$DEPLOY_HOST" 'gunzip | docker load'

      - name: Copy Caddyfile to server
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST_TST }}
        run: |
          scp Caddyfile "$DEPLOY_USER@$DEPLOY_HOST:/home/core/Caddyfile"

      - name: Deploy via Docker context
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST_TST }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL_TST }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY_TST }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY_TST }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL_TST }}
          NEXT_PUBLIC_LOGFLARE_API_TOKEN: ${{ secrets.NEXT_PUBLIC_LOGFLARE_API_TOKEN_TST }}
          NEXT_PUBLIC_LOGFLARE_CLIENT_TOKEN: ${{ secrets.NEXT_PUBLIC_LOGFLARE_CLIENT_TOKEN_TST }}
          NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${{ secrets.NEXT_PUBLIC_TURNSTILE_SITE_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          TURNSTILE_SECRET_KEY: ${{ secrets.TURNSTILE_SECRET_KEY }}
          DOMAIN: "bewerbung-test.generation-d.org" 
        run: |
          export DOCKER_HOST="ssh://$DEPLOY_USER@$DEPLOY_HOST"
          docker compose -f compose.yml -f compose.test.yml up -d --remove-orphans
